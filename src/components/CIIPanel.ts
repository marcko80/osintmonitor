import { Panel } from './Panel';
import { escapeHtml } from '@/utils/sanitize';
import { calculateCII, type CountryScore } from '@/services/country-instability';

export class CIIPanel extends Panel {
  private scores: CountryScore[] = [];

  constructor() {
    super({ id: 'cii', title: 'Country Instability Index', showCount: true, trackActivity: true });
    this.refresh();
  }

  private getLevelColor(level: CountryScore['level']): string {
    switch (level) {
      case 'critical': return '#ff4444';
      case 'high': return '#ff8800';
      case 'elevated': return '#ffaa00';
      case 'normal': return '#88aa44';
      case 'low': return '#22aa88';
    }
  }

  private getLevelEmoji(level: CountryScore['level']): string {
    switch (level) {
      case 'critical': return 'ðŸ”´';
      case 'high': return 'ðŸŸ ';
      case 'elevated': return 'ðŸŸ¡';
      case 'normal': return 'ðŸŸ¢';
      case 'low': return 'âšª';
    }
  }

  private getTrendArrow(trend: CountryScore['trend'], change: number): string {
    if (trend === 'rising') return `<span class="trend-up">â†‘${change > 0 ? change : ''}</span>`;
    if (trend === 'falling') return `<span class="trend-down">â†“${Math.abs(change)}</span>`;
    return '<span class="trend-stable">â†’</span>';
  }

  private renderCountry(country: CountryScore): string {
    const barWidth = country.score;
    const color = this.getLevelColor(country.level);
    const emoji = this.getLevelEmoji(country.level);
    const trend = this.getTrendArrow(country.trend, country.change24h);

    return `
      <div class="cii-country" data-code="${escapeHtml(country.code)}">
        <div class="cii-header">
          <span class="cii-emoji">${emoji}</span>
          <span class="cii-name">${escapeHtml(country.name)}</span>
          <span class="cii-score">${country.score}</span>
          ${trend}
        </div>
        <div class="cii-bar-container">
          <div class="cii-bar" style="width: ${barWidth}%; background: ${color};"></div>
        </div>
        <div class="cii-components">
          <span title="Unrest">U:${country.components.unrest}</span>
          <span title="Security">S:${country.components.security}</span>
          <span title="Information">I:${country.components.information}</span>
        </div>
      </div>
    `;
  }

  public async refresh(): Promise<void> {
    this.showLoading();

    try {
      this.scores = calculateCII();
      const withData = this.scores.filter(s => s.score > 0);
      this.setCount(withData.length);

      if (withData.length === 0) {
        this.content.innerHTML = '<div class="empty-state">Collecting data...</div>';
        return;
      }

      const html = withData.map(s => this.renderCountry(s)).join('');
      this.content.innerHTML = `<div class="cii-list">${html}</div>`;
    } catch (error) {
      console.error('[CIIPanel] Refresh error:', error);
      this.showError('Failed to calculate CII');
    }
  }

  public getScores(): CountryScore[] {
    return this.scores;
  }
}
